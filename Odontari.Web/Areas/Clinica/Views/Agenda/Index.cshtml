@model IEnumerable<CitaListViewModel>
@using Odontari.Web.Models.Enums
@using System.Globalization
@{
    var fecha = (DateTime)ViewBag.Fecha;
    var doctores = ViewBag.Doctores as IEnumerable<dynamic>;
    var doctorIdSel = ViewBag.DoctorIdSel as string;
    var total = (int)(ViewBag.ResumenTotal ?? 0);
    var solicitada = (int)(ViewBag.ResumenSolicitada ?? 0);
    var confirmada = (int)(ViewBag.ResumenConfirmada ?? 0);
    var cancelada = (int)(ViewBag.ResumenCancelada ?? 0);
    var finalizada = (int)(ViewBag.ResumenFinalizada ?? 0);
    var ensala = (int)(ViewBag.ResumenEnSala ?? 0);
    var enatencion = (int)(ViewBag.ResumenEnAtencion ?? 0);
    var ci = CultureInfo.GetCultureInfo("es-ES");
    var nombreDia = ci.DateTimeFormat.GetDayName(fecha.DayOfWeek);
    var nombreMes = ci.DateTimeFormat.GetMonthName(fecha.Month);
    var hoy = DateTime.Today;
    var mesActual = new DateTime(fecha.Year, fecha.Month, 1);
    var mesAnt = mesActual.AddMonths(-1);
    var mesSig = mesActual.AddMonths(1);
    var primerDiaSemana = (int)mesActual.DayOfWeek;
    if (primerDiaSemana == 0) primerDiaSemana = 7;
    var diasEnMes = DateTime.DaysInMonth(fecha.Year, fecha.Month);
    ViewData["Title"] = "Agenda de Citas";
}
@section Styles {
    <link rel="stylesheet" href="~/css/agenda.css" asp-append-version="true" />
}

<div class="agenda-page">
    <div class="agenda-header">
        <div>
            <h1>Agenda de Citas</h1>
            <p class="agenda-date mb-0">@(char.ToUpper(nombreDia[0]) + nombreDia.Substring(1)), @fecha.Day de @nombreMes de @fecha.Year</p>
        </div>
        <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem;">
            <a asp-action="VistaDinamica" asp-route-fecha="@fecha.ToString("yyyy-MM-dd")" asp-route-vista="semanal" asp-route-doctorId="@doctorIdSel" class="btn-agenda-vista-sec">Vista dinámica</a>
            <a asp-action="Create" asp-route-fechaHora="@fecha.Date.AddHours(9)" class="btn-nueva-cita">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Nueva Cita
        </a>
        </div>
    </div>

    <div class="agenda-legend">
        <span><span class="dot dot-solicitada"></span> Pendiente</span>
        <span><span class="dot dot-confirmada"></span> Confirmada</span>
        <span><span class="dot dot-ensala"></span> En sala</span>
        <span><span class="dot dot-enatencion"></span> En atención</span>
        <span><span class="dot dot-finalizada"></span> Finalizada</span>
        <span><span class="dot dot-cancelada"></span> Cancelada</span>
    </div>

    <div class="agenda-layout">
        <div class="agenda-calendar-card">
            <div class="agenda-calendar-nav">
                <a asp-action="Index" asp-route-fecha="@mesAnt" asp-route-doctorId="@doctorIdSel">‹</a>
                <span>@nombreMes @fecha.Year</span>
                <a asp-action="Index" asp-route-fecha="@mesSig" asp-route-doctorId="@doctorIdSel">›</a>
            </div>
            <div class="agenda-calendar-grid">
                <span class="day-name">LU</span><span class="day-name">MA</span><span class="day-name">MI</span><span class="day-name">JU</span><span class="day-name">VI</span><span class="day-name">SÁ</span><span class="day-name">DO</span>
                @{
                    var col = 0;
                    for (var i = 1; i < primerDiaSemana; i++, col++)
                    {
                        var dAnt = mesActual.AddDays(-(primerDiaSemana - i));
                        <a asp-action="Index" asp-route-fecha="@dAnt.Date" asp-route-doctorId="@doctorIdSel" class="day-num other-month">@dAnt.Day</a>
                    }
                    for (var d = 1; d <= diasEnMes; d++, col++)
                    {
                        var dayDate = new DateTime(fecha.Year, fecha.Month, d);
                        var isToday = dayDate.Date == hoy;
                        var isSelected = dayDate.Date == fecha.Date;
                        var css = "day-num" + (isToday ? " today" : "") + (isSelected ? " selected" : "");
                        <a asp-action="Index" asp-route-fecha="@dayDate" asp-route-doctorId="@doctorIdSel" class="@css">@d</a>
                    }
                    var rest = Math.Max(0, 42 - col);
                    for (var i = 1; i <= rest; i++)
                    {
                        var dSig = mesActual.AddDays(diasEnMes + i - 1);
                        <a asp-action="Index" asp-route-fecha="@dSig.Date" asp-route-doctorId="@doctorIdSel" class="day-num other-month">@dSig.Day</a>
                    }
                }
            </div>
            <div class="agenda-resumen">
                <h6>Resumen del día</h6>
                <ul>
                    <li><span class="r-total">Total citas</span> <span>@total</span></li>
                    <li><span class="r-confirmada">Confirmadas</span> <span>@confirmada</span></li>
                    <li><span class="r-solicitada">Pendientes</span> <span>@solicitada</span></li>
                    <li><span class="r-cancelada">Canceladas</span> <span>@cancelada</span></li>
                    @if (finalizada + ensala + enatencion > 0)
                    {
                        <li><span class="r-finalizada">Finalizadas / En curso</span> <span>@(finalizada + ensala + enatencion)</span></li>
                    }
                </ul>
            </div>
        </div>

        <div class="agenda-list-card">
            <div class="card-header">
                <h2>Horarios del día</h2>
                @if (!(ViewBag.EsDoctor == true))
                {
                    <form method="get" class="filter-doctor">
                        <input type="hidden" name="fecha" value="@fecha.ToString("yyyy-MM-dd")" />
                        <select name="doctorId" class="form-select form-select-sm" onchange="this.form.submit()">
                            <option value="">Todos los doctores</option>
                            @if (doctores != null)
                            {
                                @foreach (var d in doctores)
                                {
                                    <option value="@d.Id" selected="@(doctorIdSel == d.Id)">@(d.NombreCompleto ?? d.Email)</option>
                                }
                            }
                        </select>
                    </form>
                }
            </div>
            <div class="card-body">
                @if (Model.Any())
                {
                    @foreach (var c in Model)
                    {
                        var inicial = (c.PacienteNombre ?? "?").Length > 0 ? char.ToUpperInvariant((c.PacienteNombre ?? "?")[0]).ToString() : "?";
                        var estadoClase = "status-" + c.Estado.ToString().ToLowerInvariant();
                        var estadoNombre = c.Estado switch
                        {
                            EstadoCita.Solicitada => "Pendiente",
                            EstadoCita.Confirmada => "Confirmada",
                            EstadoCita.EnSala => "En sala",
                            EstadoCita.EnAtencion => "En atención",
                            EstadoCita.Finalizada => "Finalizada",
                            EstadoCita.Cancelada => "Cancelada",
                            _ => c.Estado.ToString()
                        };
                        <div class="agenda-item">
                            <div class="avatar">@inicial</div>
                            <div class="body">
                                <div class="hora">@c.FechaHora.ToString("HH:mm")</div>
                                <div class="paciente">@c.PacienteNombre</div>
                                <div class="motivo">@(c.Motivo ?? "Consulta")</div>
                                <div class="doctor">@(c.DoctorNombre ?? "—")</div>
                            </div>
                            <span class="status-badge @estadoClase">@estadoNombre</span>
                            <div class="actions">
                                <a asp-action="Editar" asp-route-id="@c.Id" class="btn-link">Editar</a>
                                @if (c.Estado == EstadoCita.Solicitada)
                                {
                                    <form asp-action="CambiarEstado" method="post" class="d-inline">
                                        <input type="hidden" name="id" value="@c.Id" />
                                        <input type="hidden" name="estado" value="@((int)EstadoCita.Confirmada)" />
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn-link">Confirmar</button>
                                    </form>
                                }
                                @if (c.Estado == EstadoCita.Confirmada)
                                {
                                    <form asp-action="CambiarEstado" method="post" class="d-inline">
                                        <input type="hidden" name="id" value="@c.Id" />
                                        <input type="hidden" name="estado" value="@((int)EstadoCita.EnSala)" />
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn-link">Check-in</button>
                                    </form>
                                }
                                @if (c.Estado == EstadoCita.EnSala)
                                {
                                    <a asp-controller="Atencion" asp-action="Expediente" asp-route-id="@c.Id" class="btn-link">Atender</a>
                                    <form asp-action="CambiarEstado" method="post" class="d-inline">
                                        <input type="hidden" name="id" value="@c.Id" />
                                        <input type="hidden" name="estado" value="@((int)EstadoCita.EnAtencion)" />
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn-link">Iniciar</button>
                                    </form>
                                }
                                @if (c.Estado == EstadoCita.EnAtencion)
                                {
                                    <a asp-controller="Atencion" asp-action="Expediente" asp-route-id="@c.Id" class="btn-link">Expediente</a>
                                }
                                @if (c.Estado != EstadoCita.Cancelada && c.Estado != EstadoCita.Finalizada)
                                {
                                    <form asp-action="CambiarEstado" method="post" class="d-inline">
                                        <input type="hidden" name="id" value="@c.Id" />
                                        <input type="hidden" name="estado" value="@((int)EstadoCita.Cancelada)" />
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn-link text-danger">Cancelar</button>
                                    </form>
                                }
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="agenda-empty">No hay citas este día. <a asp-action="Create" asp-route-fechaHora="@fecha.Date.AddHours(9)" style="color: var(--odon-accent);">Crear cita</a></div>
                }
            </div>
        </div>
    </div>
</div>
