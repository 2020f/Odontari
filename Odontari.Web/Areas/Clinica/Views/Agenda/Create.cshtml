@model CitaEditViewModel
@{
    var pacientes = ViewBag.Pacientes as IEnumerable<dynamic>;
    var doctores = ViewBag.Doctores as IEnumerable<dynamic>;
    var tieneErrores = !ViewData.ModelState.IsValid && ViewData.ModelState.ErrorCount > 0;
    ViewData["Title"] = "Nueva cita";
}
@section Styles {
    <link rel="stylesheet" href="~/css/agenda.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/agenda-form.css" asp-append-version="true" />
}

@if (tieneErrores)
{
    <div class="agenda-message-overlay" id="agendaMessageOverlay" role="alert" onclick="if (event.target === this) this.classList.remove('show')">
        <div class="agenda-message-flotante" onclick="event.stopPropagation()">
            <div class="agenda-message-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            </div>
            <div class="agenda-message-body">
                <h3 class="agenda-message-title">No se pudo guardar la cita</h3>
                <div class="agenda-message-text">
                    <ul class="agenda-message-list">
                        @foreach (var err in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                        {
                            <li>@err.ErrorMessage</li>
                        }
                    </ul>
                </div>
            </div>
            <button type="button" class="agenda-message-close" onclick="document.getElementById('agendaMessageOverlay').classList.remove('show')" aria-label="Cerrar">Entendido</button>
        </div>
    </div>
}

<div class="agenda-form-page">
    <div class="agenda-form-header">
        <h1 class="agenda-form-title">Nueva cita</h1>
        <a asp-action="Index" asp-route-fecha="@Model.FechaHora.Date" class="btn-agenda-form-back">
            <span aria-hidden="true">←</span> Volver a Agenda
        </a>
    </div>

    <div class="form-agenda-card form-agenda-card-styled">
        <form asp-action="Create" method="post">
            <div class="agenda-form-group">
                <label asp-for="PacienteId" class="form-label">Paciente</label>
                <select asp-for="PacienteId" class="form-select" required asp-items="@(new SelectList(pacientes ?? new List<dynamic>(), "Id", "Nombre"))">
                    <option value="">-- Seleccione paciente --</option>
                </select>
            </div>
            <div class="agenda-form-group">
                <label asp-for="DoctorId" class="form-label">Doctor</label>
                <select asp-for="DoctorId" class="form-select" required asp-items="@(new SelectList(doctores ?? new List<dynamic>(), "Id", "Nombre"))">
                    <option value="">-- Seleccione doctor --</option>
                </select>
            </div>
            <div class="agenda-form-group">
                <label asp-for="FechaHora" class="form-label">Fecha y hora</label>
                <input asp-for="FechaHora" type="datetime-local" class="form-control" />
                <span asp-validation-for="FechaHora" class="text-danger small d-block mt-1"></span>
            </div>
            <div class="agenda-form-group">
                <label asp-for="Motivo" class="form-label">Motivo / Procedimiento</label>
                <input asp-for="Motivo" class="form-control" placeholder="Ej. Limpieza general, Revisión" />
            </div>
            <div class="agenda-form-actions">
                <button type="submit" class="btn-agenda-form-primary">Guardar cita</button>
                <a asp-action="Index" asp-route-fecha="@Model.FechaHora.Date" class="btn-agenda-form-secondary">Cancelar</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    @if (tieneErrores)
    {
        <script>
            document.getElementById('agendaMessageOverlay').classList.add('show');
        </script>
    }
}
