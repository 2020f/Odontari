@model Odontari.Web.Models.Cita
@{
    var tratamientos = ViewBag.Tratamientos as IList<Odontari.Web.Models.Tratamiento> ?? new List<Odontari.Web.Models.Tratamiento>();
    var odontogramaJson = ViewBag.OdontogramaEstadoJson as string ?? "{}";
    var pacienteId = ViewBag.PacienteId as int? ?? (Model != null ? Model.PacienteId : 0);
    var historial = ViewBag.Historial as IEnumerable<Odontari.Web.ViewModels.HistorialEventoViewModel> ?? Enumerable.Empty<Odontari.Web.ViewModels.HistorialEventoViewModel>();
    var esInfantil = ViewBag.EsInfantil as bool? ?? false;
    var tipoOdontograma = ViewBag.TipoOdontograma as int? ?? 0;
    ViewData["Title"] = "Expediente - " + Model.Paciente?.Nombre;
}
@section Styles {
    <link rel="stylesheet" href="~/css/odontograma.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/agenda-form.css" asp-append-version="true" />
}

@{
    var estadoCita = Model.Estado;
    var estadoBadgeClass = estadoCita switch
    {
        Odontari.Web.Models.Enums.EstadoCita.EnAtencion => "atencion-estado-enatencion",
        Odontari.Web.Models.Enums.EstadoCita.EnSala => "atencion-estado-ensala",
        Odontari.Web.Models.Enums.EstadoCita.Finalizada => "atencion-estado-finalizada",
        Odontari.Web.Models.Enums.EstadoCita.Confirmada => "atencion-estado-confirmada",
        Odontari.Web.Models.Enums.EstadoCita.Solicitada => "atencion-estado-solicitada",
        Odontari.Web.Models.Enums.EstadoCita.Cancelada => "atencion-estado-cancelada",
        Odontari.Web.Models.Enums.EstadoCita.NoShow => "atencion-estado-noshow",
        _ => "atencion-estado-default"
    };
}
@if (TempData["MostrarMensajePreciosProcedimientos"] != null)
{
    <div class="agenda-message-overlay atencion-message-overlay show" id="mensajePreciosProcedimientos" role="alert" onclick="if (event.target === this) this.classList.remove('show')">
        <div class="agenda-message-flotante" onclick="event.stopPropagation()">
            <div class="agenda-message-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
            </div>
            <div class="agenda-message-body">
                <h3 class="agenda-message-title">Precios pendientes</h3>
                <p class="agenda-message-text">Para continuar debe agregar los precios a los procedimientos. Defina el precio en cada fila que muestre RD$ 0,00 y luego podrá marcarlos como realizados.</p>
            </div>
            <button type="button" class="agenda-message-close" onclick="document.getElementById('mensajePreciosProcedimientos').classList.remove('show')" aria-label="Cerrar">Entendido</button>
        </div>
    </div>
}
<div class="atencion-section">
<div class="atencion-header">
    <div class="atencion-header-top">
        <span class="atencion-header-label">Evaluación del paciente</span>
        <h1 class="atencion-patient-name">@Model.Paciente?.Nombre @Model.Paciente?.Apellidos</h1>
    </div>
    <div class="atencion-header-meta">
        <span class="atencion-cita-fecha">
            <span class="atencion-meta-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg></span>
            Cita: @Model.FechaHora.ToString("dd/MM/yyyy HH:mm")
        </span>
        <span class="atencion-estado-badge @estadoBadgeClass">@estadoCita</span>
    </div>
    <div class="atencion-header-links">
        <a asp-controller="Agenda" asp-action="Index" asp-route-fecha="@Model.FechaHora.Date">← Volver a agenda</a>
        <a asp-controller="Expediente" asp-action="Index" asp-route-id="@Model.PacienteId">Expediente completo</a>
    </div>
    @if (Model.Estado == Odontari.Web.Models.Enums.EstadoCita.EnSala)
    {
        <form asp-action="CambiarEstado" asp-controller="Agenda" method="post" class="atencion-header-action">
            <input type="hidden" name="id" value="@Model.Id" />
            <input type="hidden" name="estado" value="@((int)Odontari.Web.Models.Enums.EstadoCita.EnAtencion)" />
            @Html.AntiForgeryToken()
            <button type="submit" class="btn btn-light btn-sm">Iniciar atención</button>
        </form>
    }
</div>

<ul class="nav nav-tabs atencion-tabs" role="tablist">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tabProcedimientos">Procedimientos</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabOdontograma">Odontograma</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabHistograma">Histograma</a></li>
</ul>

<div class="tab-content">
    <div id="tabProcedimientos" class="tab-pane fade show active">
        <h2>Procedimientos</h2>
        <table class="table">
            <thead>
                <tr><th>Tratamiento</th><th>Precio</th><th>Realizado</th><th></th></tr>
            </thead>
            <tbody>
                @foreach (var pr in Model.ProcedimientosRealizados)
                {
                    <tr>
                        <td>@pr.Tratamiento?.Nombre @if (!string.IsNullOrEmpty(pr.Notas)) { <span class="text-muted small">(@pr.Notas)</span> }</td>
                        <td>
                            @if (pr.PrecioAplicado == 0 && !pr.MarcadoRealizado)
                            {
                                <form asp-action="ActualizarPrecioProcedimiento" method="post" class="d-inline-flex align-items-center gap-1">
                                    <input type="hidden" name="procedimientoId" value="@pr.Id" />
                                    <input type="number" name="precio" value="0" min="0" step="0.01" class="form-control form-control-sm" style="width:100px" placeholder="Precio" required />
                                    <span class="small">RD$</span>
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-sm btn-outline-secondary">Definir precio</button>
                                </form>
                            }
                            else
                            {
                                <text>RD$ @pr.PrecioAplicado.ToString("N2")</text>
                            }
                        </td>
                        <td>@(pr.MarcadoRealizado ? "Sí" : "No")</td>
                        <td>
                            @if (!pr.MarcadoRealizado)
                            {
                                <form asp-action="MarcarRealizado" method="post" class="d-inline">
                                    <input type="hidden" name="procedimientoId" value="@pr.Id" />
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-sm btn-outline-primary">Marcar realizado</button>
                                </form>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <h3>Agregar procedimiento</h3>
        <form asp-action="AgregarProcedimiento" method="post">
            <input type="hidden" name="citaId" value="@Model.Id" />
            <select name="tratamientoId" class="form-control d-inline-block w-auto" required>
                <option value="">-- Seleccionar tratamiento --</option>
                @foreach (var t in tratamientos)
                {
                    <option value="@t.Id">@t.Nombre - RD$ @t.PrecioBase.ToString("N2")</option>
                }
            </select>
            @Html.AntiForgeryToken()
            <button type="submit" class="btn btn-primary">Agregar</button>
        </form>

        @if (Model.Estado == Odontari.Web.Models.Enums.EstadoCita.EnAtencion && Model.ProcedimientosRealizados.Any(pr => pr.MarcadoRealizado))
        {
            <hr />
            <form asp-action="FinalizarAtencion" method="post">
                <input type="hidden" name="id" value="@Model.Id" />
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-success">Finalizar atención (generar orden de cobro)</button>
            </form>
        }
    </div>

    <div id="tabOdontograma" class="tab-pane fade">
        <div class="odontograma-wrapper">
        <div class="odontograma-pro">
            <div class="odontograma-panel-left">
                <h6>Modo de edición</h6>
                <div class="modo-edicion">
                    <button type="button" class="btn-modo active" id="btnModoAtSuperficie" data-modo="superficie">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
                        Superficie
                    </button>
                    <button type="button" class="btn-modo" id="btnModoAtDiente" data-modo="diente">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2C8 2 6 4 6 8c0 4 2 8 6 14 4-6 6-10 6-14 0-4-2-6-6-6z"/></svg>
                        Diente
                    </button>
                </div>
                <input type="hidden" name="modoAt" id="modoAtSuperficie" value="diente" />

                <h6 id="labelEstadosAt">Estados de diente</h6>
                <div id="panelAtSuperficie" class="mb-2">
                    <div class="estados-superficie">
                        <button type="button" class="btn-estado active" data-state="CARIES"><span class="swatch" style="background:#E53935"></span>Caries</button>
                        <button type="button" class="btn-estado" data-state="OBTURACION"><span class="swatch" style="background:#1E88E5"></span>Obturación</button>
                        <button type="button" class="btn-estado" data-state="SELLANTE"><span class="swatch" style="background:#26C6DA"></span>Sellante</button>
                        <button type="button" class="btn-estado" data-state="FRACTURA"><span class="swatch" style="background:#FF8F00"></span>Fractura</button>
                        <button type="button" class="btn-estado" data-state="NONE"><span class="swatch" style="background:#b0bec5;border-style:dashed"></span>Borrar</button>
                    </div>
                </div>
                <div id="panelAtDiente" class="mb-2" style="display:none">
                    <div class="estados-diente">
                        @if (esInfantil)
                        {
                            <button type="button" class="btn-estado active" data-state="NONE"><span class="swatch" style="background:#fff;border:1px solid #999"></span>Normal</button>
                            <button type="button" class="btn-estado" data-state="AUSENTE"><span class="swatch" style="background:#78909C"></span>Ausente</button>
                            <button type="button" class="btn-estado" data-state="EXFOLIADO"><span class="swatch" style="background:#C62828"></span>Exfoliado</button>
                            <button type="button" class="btn-estado" data-state="ERUPCION"><span class="swatch" style="background:#43A047"></span>Erupción</button>
                        }
                        else
                        {
                            <button type="button" class="btn-estado active" data-state="NONE"><span class="swatch" style="background:#fff;border:1px solid #999"></span>Normal</button>
                            <button type="button" class="btn-estado" data-state="AUSENTE"><span class="swatch" style="background:#78909C"></span>Ausente</button>
                            <button type="button" class="btn-estado" data-state="EXTRAIDO"><span class="swatch" style="background:#C62828"></span>Extraído</button>
                            <button type="button" class="btn-estado" data-state="CORONA"><span class="swatch" style="background:#F9A825"></span>Corona</button>
                            <button type="button" class="btn-estado" data-state="ENDODONCIA"><span class="swatch" style="background:#2E7D32"></span>Endodoncia</button>
                            <button type="button" class="btn-estado" data-state="IMPLANTE"><span class="swatch" style="background:#6A1B9A"></span>Implante</button>
                            <button type="button" class="btn-estado" data-state="PROTESIS"><span class="swatch" style="background:#00838F"></span>Prótesis</button>
                        }
                    </div>
                </div>

                <div class="odontograma-leyenda">
                    <h6>Leyenda</h6>
                    <div class="leyenda-item"><span class="leyenda-swatch" style="background:#E53935"></span>Caries</div>
                    <div class="leyenda-item"><span class="leyenda-swatch" style="background:#1E88E5"></span>Obturación</div>
                    <div class="leyenda-item"><span class="leyenda-swatch" style="background:#26C6DA"></span>Sellante</div>
                    <div class="leyenda-item"><span class="leyenda-swatch" style="background:#FF8F00"></span>Fractura</div>
                    <div class="leyenda-item"><span class="leyenda-swatch" style="background:#78909C"></span>Ausente</div>
                    @if (esInfantil)
                    {
                        <div class="leyenda-item"><span class="leyenda-swatch" style="background:#C62828"></span>Exfoliado</div>
                        <div class="leyenda-item"><span class="leyenda-swatch" style="background:#43A047"></span>Erupción</div>
                    }
                    else
                    {
                        <div class="leyenda-item"><span class="leyenda-swatch" style="background:#C62828"></span>Extraído</div>
                        <div class="leyenda-item"><span class="leyenda-swatch" style="background:#F9A825"></span>Corona</div>
                        <div class="leyenda-item"><span class="leyenda-swatch" style="background:#2E7D32"></span>Endodoncia</div>
                        <div class="leyenda-item"><span class="leyenda-swatch" style="background:#6A1B9A"></span>Implante</div>
                        <div class="leyenda-item"><span class="leyenda-swatch" style="background:#00838F"></span>Prótesis</div>
                    }
                </div>
            </div>

            <div class="odontograma-panel-center">
                <div class="odontograma-card">
                    <div class="orientacion">
                        <span>Derecho del paciente</span>
                        <span>Izquierdo del paciente</span>
                    </div>
                    <div class="arcada-label-top">ARCADA SUPERIOR</div>
                    <div class="odontograma-svg-wrap">
                        <svg id="odontogramaSvgAt" class="odontograma-svg" width="800" height="420" viewBox="-60 0 930 420" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg"></svg>
                    </div>
                    <div class="arcada-label-bottom">ARCADA INFERIOR</div>
                </div>
                <button type="button" class="btn-guardar-odon mt-3" id="btnGuardarAt">Guardar odontograma</button>
                <span id="guardarMsgAt" class="ms-2 text-muted small"></span>
            </div>

            <div class="odontograma-panel-right">
                <div>
                    <h6>Hallazgos</h6>
                    <div id="hallazgosAt" class="hallazgos-list">Sin hallazgos registrados.</div>
                </div>
                <div>
                    <h6>Observaciones</h6>
                    <textarea id="observacionesAt" class="odontograma-observaciones form-control" placeholder="Notas clínicas adicionales..."></textarea>
                </div>
                <div>
                    <h6>Estadísticas</h6>
                    <div class="odontograma-stats">
                        <div class="odontograma-stat"><span class="number" id="statHallazgosAt">0</span><br><span class="label">Hallazgos</span></div>
                        <div class="odontograma-stat"><span class="number" id="statDientesAt">0</span><br><span class="label">Dientes afectados</span></div>
                    </div>
                </div>
            </div>
        </div>
        </div>
        <input type="hidden" id="pacienteIdAt" value="@pacienteId" />
        <input type="hidden" id="citaIdAt" value="@Model.Id" />
        <input type="hidden" id="estadoInicialAt" value="@Html.Raw(odontogramaJson)" />
        <input type="hidden" id="tipoOdontogramaAt" value="@tipoOdontograma" />
    </div>

    <div id="tabHistograma" class="tab-pane fade">
        <h2>Histograma (línea de tiempo clínica)</h2>
        <p class="text-muted">Eventos registrados en el expediente del paciente.</p>
        <p><a asp-controller="Expediente" asp-action="Histograma" asp-route-id="@pacienteId" asp-route-citaId="@Model.Id" class="btn btn-outline-primary btn-sm">Ver Histograma completo (resumen + timeline + odontograma)</a></p>
        <table class="table table-sm">
            <thead><tr><th>Fecha</th><th>Tipo</th><th>Descripción</th></tr></thead>
            <tbody>
                @foreach (var h in historial)
                {
                    <tr>
                        <td>@h.FechaEvento.ToString("dd/MM/yyyy HH:mm")</td>
                        <td>@h.TipoEvento</td>
                        <td>@(h.Descripcion ?? "—")</td>
                    </tr>
                }
            </tbody>
        </table>
        @if (!historial.Any())
        {
            <p class="text-muted">No hay eventos registrados.</p>
        }
    </div>
</div>
</div>

@section Scripts {
    @if (esInfantil)
    {
        <script src="~/js/odontograma-atencion-infantil.js" asp-append-version="true"></script>
    }
    else
    {
        <script src="~/js/odontograma-atencion.js" asp-append-version="true"></script>
    }
}
