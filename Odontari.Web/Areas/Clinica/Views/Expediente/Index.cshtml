@model Odontari.Web.ViewModels.ExpedienteIndexViewModel
@{
    var paciente = ViewBag.Paciente as Odontari.Web.Models.Paciente;
    ViewData["Title"] = "Expediente - " + Model.Nombre;
}

@await Html.PartialAsync("_ExpedienteMenu")

<div class="expediente-header">
    <h1 class="expediente-title">@Model.Nombre @Model.Apellidos</h1>
    <p class="expediente-sub mb-0">@(Model.Cedula ?? "—") @(Model.Telefono != null ? " · " + Model.Telefono : "")</p>
</div>

@if (!string.IsNullOrEmpty(Model.Alergias))
{
    <div class="expediente-alert">
        <strong>Alergias:</strong> @Model.Alergias
    </div>
}

@{
    var seccionActiva = ViewBag.SeccionActivaExpediente as string ?? "resumen";
    var mostrarResumen = seccionActiva == "resumen";
    var mostrarHistorial = seccionActiva == "historial";
}
<div class="tab-content expediente-tab-content">
    <div id="resumen" class="tab-pane fade @(mostrarResumen ? "show active" : "")">
        <div class="content-card" style="padding: 1.5rem;">
            <h2 class="expediente-section-title">Datos generales</h2>
            <div class="expediente-datos">
                <div class="datos-item">
                    <div class="datos-label">Nombre</div>
                    <div class="datos-value">@Model.Nombre @Model.Apellidos</div>
                </div>
                <div class="datos-item">
                    <div class="datos-label">Cédula</div>
                    <div class="datos-value">@(Model.Cedula ?? "—")</div>
                </div>
                <div class="datos-item">
                    <div class="datos-label">Teléfono</div>
                    <div class="datos-value">@(Model.Telefono ?? "—")</div>
                </div>
                <div class="datos-item">
                    <div class="datos-label">Alergias</div>
                    <div class="datos-value">@(Model.Alergias ?? "Ninguna registrada")</div>
                </div>
                <div class="datos-item">
                    <div class="datos-label">Notas clínicas</div>
                    <div class="datos-value">@(Model.NotasClinicas ?? "—")</div>
                </div>
            </div>
            <div class="expediente-actions-block">
                <a asp-action="Odontograma" asp-route-id="@Model.PacienteId" class="btn btn-primary">Abrir Odontograma</a>
                <a asp-action="HistoriaClinicaSistematica" asp-route-id="@Model.PacienteId" class="btn btn-outline-secondary">Historia Clínica Sistemática</a>
            </div>
        </div>
    </div>
    <div id="historial" class="tab-pane fade @(mostrarHistorial ? "show active" : "")">
        <div class="content-card">
            <div style="padding: 1rem 1.25rem 0;">
                <h2 class="expediente-section-title">Historial clínico (últimos 20 eventos)</h2>
            </div>
            @if (Model.Historial.Any())
            {
                <table class="table expediente-historial">
                    <thead><tr><th>Fecha</th><th>Tipo</th><th>Descripción</th></tr></thead>
                    <tbody>
                        @foreach (var h in Model.Historial)
                        {
                            <tr>
                                <td>@h.FechaEvento.ToString("dd/MM/yyyy HH:mm")</td>
                                <td>@h.TipoEvento</td>
                                <td>@(h.Descripcion ?? "—")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <div class="expediente-empty" style="padding: 1.5rem 1.25rem;">No hay eventos registrados.</div>
            }
        </div>
    </div>
</div>
