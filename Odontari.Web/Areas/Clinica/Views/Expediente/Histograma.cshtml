@model Odontari.Web.ViewModels.HistogramaViewModel
@{
    var paciente = ViewBag.Paciente as Odontari.Web.Models.Paciente;
    ViewData["Title"] = "Histograma - " + Model.Nombre;
    var edad = Model.FechaNacimiento.HasValue ? (DateTime.Today.Year - Model.FechaNacimiento.Value.Year) : (int?)null;
}

<div class="expediente-header mb-3">
    <a asp-controller="Pacientes" asp-action="Index" class="btn-content-secondary mb-2" style="display: inline-flex; align-items: center; gap: 0.35rem;">← Volver a Pacientes</a>
    <h1 class="expediente-title">Histograma (Historial / Resumen clínico)</h1>
    <p class="expediente-sub mb-0">@Model.Nombre @Model.Apellidos @(Model.Cedula != null ? " · " + Model.Cedula : "") @(edad.HasValue ? " · " + edad + " años" : "")</p>
</div>

@await Html.PartialAsync("_ExpedienteMenu")

@if (!string.IsNullOrEmpty(Model.Alergias))
{
    <div class="alert alert-warning mb-3"><strong>Alergias:</strong> @Model.Alergias</div>
}

<!-- Resumen rápido -->
<section class="card mb-4">
    <div class="card-header"><h5 class="mb-0">Resumen rápido</h5></div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <h6 class="text-muted">Última visita</h6>
                <p class="mb-0">@(Model.UltimaVisita ?? "Sin registros")</p>
            </div>
            <div class="col-md-4">
                <h6 class="text-muted">Último diagnóstico / procedimiento</h6>
                <p class="mb-0">@(Model.UltimoDiagnostico ?? "—")</p>
            </div>
            <div class="col-md-4">
                <h6 class="text-muted">Próximo paso</h6>
                <p class="mb-0">@(Model.ProximoPaso ?? "Ninguno programado")</p>
            </div>
        </div>
    </div>
</section>

<!-- Datos del paciente -->
<section class="card mb-4">
    <div class="card-header"><h5 class="mb-0">Datos del paciente</h5></div>
    <div class="card-body">
        <dl class="row mb-0">
            <dt class="col-sm-2">Nombre</dt>
            <dd class="col-sm-10">@Model.Nombre @Model.Apellidos</dd>
            <dt class="col-sm-2">Documento / Cédula</dt>
            <dd class="col-sm-10">@(Model.Cedula ?? "—")</dd>
            <dt class="col-sm-2">Contacto</dt>
            <dd class="col-sm-10">@(Model.Telefono ?? Model.Email ?? "—")</dd>
            <dt class="col-sm-2">Alergias</dt>
            <dd class="col-sm-10">
                @if (Model.HistoriaClinicaSistematica?.AlergiasMedicamentos == true && !string.IsNullOrWhiteSpace(Model.HistoriaClinicaSistematica.AlergiasCuales))
                {
                    @Model.HistoriaClinicaSistematica.AlergiasCuales
                }
                else
                {
                    @(Model.Alergias ?? "Ninguna registrada")
                }
            </dd>
            <dt class="col-sm-2">Notas clínicas</dt>
            <dd class="col-sm-10">@(Model.NotasClinicas ?? "—")</dd>
        </dl>

        @if (Model.HistoriaClinicaSistematica?.TieneDatos == true)
        {
            var h = Model.HistoriaClinicaSistematica;
            <hr class="my-4" />
            <h6 class="text-muted mb-3">Historia clínica sistemática (antecedentes médicos)</h6>
            <div class="row">
                <div class="col-md-6">
                    <ul class="list-unstyled small mb-0">
                        <li>1. Alergias a medicamentos y/o anestésicos: @(h.AlergiasMedicamentos == true ? "Sí" : h.AlergiasMedicamentos == false ? "No" : "—") @(h.AlergiasMedicamentos == true && !string.IsNullOrWhiteSpace(h.AlergiasCuales) ? "— " + h.AlergiasCuales : "")</li>
                        <li>3. Asma bronquial: @(h.AsmaBronquial == true ? "Sí" : h.AsmaBronquial == false ? "No" : "—")</li>
                        <li>4. Convulsiones o epilepsia: @(h.ConvulsionesEpilepsia == true ? "Sí" : h.ConvulsionesEpilepsia == false ? "No" : "—")</li>
                        <li>5. Diabetes: @(h.Diabetes == true ? "Sí" : h.Diabetes == false ? "No" : "—")</li>
                        <li>6. Enfermedades cardíacas: @(h.EnfermedadesCardiacas == true ? "Sí" : h.EnfermedadesCardiacas == false ? "No" : "—")</li>
                        <li>7. Embarazo: @(h.Embarazo == true ? "Sí" + (h.EmbarazoSemanas.HasValue ? " (" + h.EmbarazoSemanas + " semanas)" : "") : h.Embarazo == false ? "No" : "—")</li>
                        <li>8. Enfermedades venéreas, sífilis, SIDA: @(h.EnfermedadesVenereas == true ? "Sí" : h.EnfermedadesVenereas == false ? "No" : "—")</li>
                        <li>9. Fiebre reumática: @(h.FiebreReumatica == true ? "Sí" : h.FiebreReumatica == false ? "No" : "—")</li>
                        <li>10. Hepatitis: @(h.Hepatitis == true ? "Sí" + (!string.IsNullOrWhiteSpace(h.HepatitisCual) ? " (" + h.HepatitisCual + ")" : "") : h.Hepatitis == false ? "No" : "—")</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <ul class="list-unstyled small mb-0">
                        <li>11. Problemas neurológicos: @(h.ProblemasNeurologicos == true ? "Sí" : h.ProblemasNeurologicos == false ? "No" : "—")</li>
                        <li>12. Problemas renales: @(h.ProblemasRenales == true ? "Sí" : h.ProblemasRenales == false ? "No" : "—")</li>
                        <li>13. Problemas sinusales: @(h.ProblemasSinusales == true ? "Sí" : h.ProblemasSinusales == false ? "No" : "—")</li>
                        <li>14. Sangrado excesivo: @(h.SangradoExcesivo == true ? "Sí" : h.SangradoExcesivo == false ? "No" : "—")</li>
                        <li>15. Trastornos psiquiátricos: @(h.TrastornosPsiquiatricos == true ? "Sí" : h.TrastornosPsiquiatricos == false ? "No" : "—")</li>
                        <li>16. Trastornos digestivos: @(h.TrastornosDigestivos == true ? "Sí" : h.TrastornosDigestivos == false ? "No" : "—")</li>
                        <li>17. Tumores benignos y/o malignos: @(h.TumoresBenignosMalignos == true ? "Sí" + (!string.IsNullOrWhiteSpace(h.TumoresCuales) ? " (" + h.TumoresCuales + ")" : "") : h.TumoresBenignosMalignos == false ? "No" : "—")</li>
                        <li>19. Trastornos respiratorios: @(h.TrastornosRespiratorios == true ? "Sí" + (!string.IsNullOrWhiteSpace(h.TrastornosRespiratoriosCuales) ? " (" + h.TrastornosRespiratoriosCuales + ")" : "") : h.TrastornosRespiratorios == false ? "No" : "—")</li>
                    </ul>
                </div>
            </div>
            <p class="mt-2 mb-0 small"><a asp-action="HistoriaClinicaSistematica" asp-route-id="@Model.PacienteId">Editar historia clínica sistemática</a></p>
        }
        else
        {
            <p class="mt-3 mb-0 small text-muted"><a asp-action="HistoriaClinicaSistematica" asp-route-id="@Model.PacienteId">Completar historia clínica sistemática</a></p>
        }
    </div>
</section>

<!-- Timeline -->
<section class="card mb-4">
    <div class="card-header"><h5 class="mb-0">Timeline (histórico)</h5></div>
    <div class="card-body p-0">
        @if (Model.Timeline.Any())
        {
            <div class="table-responsive">
                <table class="table table-sm table-striped mb-0">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Tipo de evento</th>
                            <th>Descripción</th>
                            <th class="text-end">Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var h in Model.Timeline)
                        {
                            <tr>
                                <td>@h.FechaEvento.ToString("dd/MM/yyyy HH:mm")</td>
                                <td>@h.TipoEvento</td>
                                <td>@(h.Descripcion ?? "—")</td>
                                <td class="text-end">
                                    @if (h.CitaId.HasValue)
                                    {
                                        <a asp-controller="Atencion" asp-action="Expediente" asp-route-id="@h.CitaId.Value" class="btn btn-sm btn-outline-primary">Ver</a>
                                    }
                                    else
                                    {
                                        <a asp-action="VerEvento" asp-route-id="@h.Id" asp-route-pacienteId="@Model.PacienteId" class="btn btn-sm btn-outline-secondary">Ver</a>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <p class="p-3 mb-0 text-muted">No hay eventos en el historial.</p>
        }
    </div>
</section>

<!-- Resumen odontograma -->
<section class="card mb-4">
    <div class="card-header"><h5 class="mb-0">Resumen odontograma</h5></div>
    <div class="card-body">
        @if (Model.ResumenOdontograma != null)
        {
            var r = Model.ResumenOdontograma;
            <p class="text-muted small mb-3">Última actualización: @(r.UltimaActualizacion?.ToString("dd/MM/yyyy HH:mm") ?? "—")</p>
            <div class="row mb-3">
                <div class="col-auto"><span class="badge bg-danger me-1">Caries</span> @r.Caries</div>
                <div class="col-auto"><span class="badge bg-info me-1">Restauraciones</span> @r.Restauraciones</div>
                <div class="col-auto"><span class="badge bg-secondary me-1">Ausentes</span> @r.Ausentes</div>
                <div class="col-auto"><span class="badge bg-success me-1">Endodoncia</span> @r.Endodoncia</div>
                <div class="col-auto"><span class="badge bg-dark me-1">Otros</span> @r.Otros</div>
            </div>
            <p class="mb-1"><strong>Total hallazgos:</strong> @r.TotalHallazgos dientes</p>
            @if (r.UltimosDientesConHallazgo.Any())
            {
                <p class="mb-2"><strong>Dientes con hallazgo:</strong> @string.Join(", ", r.UltimosDientesConHallazgo)</p>
            }
            @if (r.ListaHallazgos.Any())
            {
                <h6 class="mt-3 mb-2">Lista de hallazgos</h6>
                <div class="hallazgos-list-resumen border rounded p-2 bg-light" style="max-height: 220px; overflow-y: auto;">
                    @foreach (var h in r.ListaHallazgos)
                    {
                        <div class="hallazgo-item small py-1">@h</div>
                    }
                </div>
            }
        }
        else
        {
            <p class="text-muted mb-0">No hay odontograma registrado. <a asp-action="Odontograma" asp-route-id="@Model.PacienteId">Abrir odontograma</a></p>
        }
    </div>
</section>

