@model Odontari.Web.ViewModels.HistogramaViewModel
@{
    var paciente = ViewBag.Paciente as Odontari.Web.Models.Paciente;
    ViewData["Title"] = "Histograma - " + Model.Nombre;
    var edad = Model.FechaNacimiento.HasValue ? (DateTime.Today.Year - Model.FechaNacimiento.Value.Year) : (int?)null;
}

@await Html.PartialAsync("_ExpedienteMenu")

<div class="histograma-patient-card content-card mb-3">
    <div class="histograma-patient-info">
        <div class="histograma-patient-avatar" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        </div>
        <div class="histograma-patient-meta">
            <h1 class="histograma-patient-name">@Model.Nombre @Model.Apellidos</h1>
            @if (edad.HasValue)
            {
                <p class="histograma-patient-detail">
                    <span class="histograma-detail-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg></span>
                    @edad años
                </p>
            }
            <p class="histograma-patient-detail">
                <span class="histograma-detail-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg></span>
                @(Model.Telefono ?? Model.Cedula ?? "—")
            </p>
        </div>
    </div>
    @if (!string.IsNullOrEmpty(Model.Alergias))
    {
        <div class="histograma-allergy-alert">
            <span class="histograma-allergy-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></span>
            <span>@Model.Alergias</span>
        </div>
    }
</div>

<h2 class="expediente-section-title mt-2 mb-2">Histograma (Historial / Resumen clínico)</h2>

<!-- Datos del paciente (siempre primero) -->
<section class="card mb-4">
    <div class="card-header"><h5 class="mb-0">Datos del paciente</h5></div>
    <div class="card-body">
        <dl class="row mb-0">
            <dt class="col-sm-2">Nombre</dt>
            <dd class="col-sm-10">@Model.Nombre @Model.Apellidos</dd>
            <dt class="col-sm-2">Documento / Cédula</dt>
            <dd class="col-sm-10">@(Model.Cedula ?? "—")</dd>
            <dt class="col-sm-2">Contacto</dt>
            <dd class="col-sm-10">@(Model.Telefono ?? Model.Email ?? "—")</dd>
            <dt class="col-sm-2">Alergias</dt>
            <dd class="col-sm-10">
                @if (Model.HistoriaClinicaSistematica?.AlergiasMedicamentos == true && !string.IsNullOrWhiteSpace(Model.HistoriaClinicaSistematica.AlergiasCuales))
                {
                    @Model.HistoriaClinicaSistematica.AlergiasCuales
                }
                else
                {
                    @(Model.Alergias ?? "Ninguna registrada")
                }
            </dd>
            <dt class="col-sm-2">Notas clínicas</dt>
            <dd class="col-sm-10">@(Model.NotasClinicas ?? "—")</dd>
        </dl>

        @if (Model.HistoriaClinicaSistematica?.TieneDatos == true)
        {
            var h = Model.HistoriaClinicaSistematica;
            <hr class="my-4" />
            <h6 class="text-muted mb-3">Historia clínica sistemática (antecedentes médicos)</h6>
            <div class="row">
                <div class="col-md-6">
                    <ul class="list-unstyled small mb-0">
                        <li>1. Alergias a medicamentos y/o anestésicos: @(h.AlergiasMedicamentos == true ? "Sí" : h.AlergiasMedicamentos == false ? "No" : "—") @(h.AlergiasMedicamentos == true && !string.IsNullOrWhiteSpace(h.AlergiasCuales) ? "— " + h.AlergiasCuales : "")</li>
                        <li>3. Asma bronquial: @(h.AsmaBronquial == true ? "Sí" : h.AsmaBronquial == false ? "No" : "—")</li>
                        <li>4. Convulsiones o epilepsia: @(h.ConvulsionesEpilepsia == true ? "Sí" : h.ConvulsionesEpilepsia == false ? "No" : "—")</li>
                        <li>5. Diabetes: @(h.Diabetes == true ? "Sí" : h.Diabetes == false ? "No" : "—")</li>
                        <li>6. Enfermedades cardíacas: @(h.EnfermedadesCardiacas == true ? "Sí" : h.EnfermedadesCardiacas == false ? "No" : "—")</li>
                        <li>7. Embarazo: @(h.Embarazo == true ? "Sí" + (h.EmbarazoSemanas.HasValue ? " (" + h.EmbarazoSemanas + " semanas)" : "") : h.Embarazo == false ? "No" : "—")</li>
                        <li>8. Enfermedades venéreas, sífilis, SIDA: @(h.EnfermedadesVenereas == true ? "Sí" : h.EnfermedadesVenereas == false ? "No" : "—")</li>
                        <li>9. Fiebre reumática: @(h.FiebreReumatica == true ? "Sí" : h.FiebreReumatica == false ? "No" : "—")</li>
                        <li>10. Hepatitis: @(h.Hepatitis == true ? "Sí" + (!string.IsNullOrWhiteSpace(h.HepatitisCual) ? " (" + h.HepatitisCual + ")" : "") : h.Hepatitis == false ? "No" : "—")</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <ul class="list-unstyled small mb-0">
                        <li>11. Problemas neurológicos: @(h.ProblemasNeurologicos == true ? "Sí" : h.ProblemasNeurologicos == false ? "No" : "—")</li>
                        <li>12. Problemas renales: @(h.ProblemasRenales == true ? "Sí" : h.ProblemasRenales == false ? "No" : "—")</li>
                        <li>13. Problemas sinusales: @(h.ProblemasSinusales == true ? "Sí" : h.ProblemasSinusales == false ? "No" : "—")</li>
                        <li>14. Sangrado excesivo: @(h.SangradoExcesivo == true ? "Sí" : h.SangradoExcesivo == false ? "No" : "—")</li>
                        <li>15. Trastornos psiquiátricos: @(h.TrastornosPsiquiatricos == true ? "Sí" : h.TrastornosPsiquiatricos == false ? "No" : "—")</li>
                        <li>16. Trastornos digestivos: @(h.TrastornosDigestivos == true ? "Sí" : h.TrastornosDigestivos == false ? "No" : "—")</li>
                        <li>17. Tumores benignos y/o malignos: @(h.TumoresBenignosMalignos == true ? "Sí" + (!string.IsNullOrWhiteSpace(h.TumoresCuales) ? " (" + h.TumoresCuales + ")" : "") : h.TumoresBenignosMalignos == false ? "No" : "—")</li>
                        <li>19. Trastornos respiratorios: @(h.TrastornosRespiratorios == true ? "Sí" + (!string.IsNullOrWhiteSpace(h.TrastornosRespiratoriosCuales) ? " (" + h.TrastornosRespiratoriosCuales + ")" : "") : h.TrastornosRespiratorios == false ? "No" : "—")</li>
                    </ul>
                </div>
            </div>
            <p class="mt-2 mb-0 small"><a asp-action="HistoriaClinicaSistematica" asp-route-id="@Model.PacienteId">Editar historia clínica sistemática</a></p>
        }
        else
        {
            <p class="mt-3 mb-0 small text-muted"><a asp-action="HistoriaClinicaSistematica" asp-route-id="@Model.PacienteId">Completar historia clínica sistemática</a></p>
        }
    </div>
</section>

<!-- Resumen odontograma (después de datos del paciente) -->
<section class="card mb-4">
    <div class="card-header"><h5 class="mb-0">Resumen odontograma</h5></div>
    <div class="card-body">
        @if (Model.ResumenOdontograma != null)
        {
            var r = Model.ResumenOdontograma;
            <p class="text-muted small mb-3">Última actualización: @(r.UltimaActualizacion?.ToString("dd/MM/yyyy HH:mm") ?? "—")</p>
            <div class="row mb-3">
                <div class="col-auto"><span class="badge bg-danger me-1">Caries</span> @r.Caries</div>
                <div class="col-auto"><span class="badge bg-info me-1">Restauraciones</span> @r.Restauraciones</div>
                <div class="col-auto"><span class="badge bg-secondary me-1">Ausentes</span> @r.Ausentes</div>
                <div class="col-auto"><span class="badge bg-success me-1">Endodoncia</span> @r.Endodoncia</div>
                <div class="col-auto"><span class="badge bg-dark me-1">Otros</span> @r.Otros</div>
            </div>
            <p class="mb-1"><strong>Total hallazgos:</strong> @r.TotalHallazgos dientes</p>
            @if (r.UltimosDientesConHallazgo.Any())
            {
                <p class="mb-2"><strong>Dientes con hallazgo:</strong> @string.Join(", ", r.UltimosDientesConHallazgo)</p>
            }
            @if (r.ListaHallazgos.Any())
            {
                <h6 class="mt-3 mb-2">Lista de hallazgos</h6>
                <div class="hallazgos-list-resumen border rounded p-2 bg-light" style="max-height: 220px; overflow-y: auto;">
                    @foreach (var h in r.ListaHallazgos)
                    {
                        <div class="hallazgo-item small py-1">@h</div>
                    }
                </div>
            }
        }
        else
        {
            <p class="text-muted mb-0">No hay odontograma registrado. <a asp-action="Odontograma" asp-route-id="@Model.PacienteId">Abrir odontograma</a></p>
        }
    </div>
</section>

<!-- Resumen rápido o Resumen / Hallazgos del periodontograma (según último evento) -->
<section class="card mb-4">
    <div class="card-header"><h5 class="mb-0">@(Model.UltimoDiagnosticoEsPeriodontograma ? "Resumen del periodontograma" : "Resumen rápido")</h5></div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <h6 class="text-muted">Última visita</h6>
                <p class="mb-0">@(Model.UltimaVisita ?? "Sin registros")</p>
            </div>
            <div class="col-md-4">
                <h6 class="text-muted">@(Model.UltimoDiagnosticoEsPeriodontograma ? "Hallazgos del periodontograma" : "Último diagnóstico / procedimiento")</h6>
                <div class="ultimo-diagnostico-block small @(string.IsNullOrEmpty(Model.UltimoDiagnostico) ? "" : "border rounded p-2 bg-light")" style="max-height: 200px; overflow-y: auto;">
                    @if (!string.IsNullOrEmpty(Model.UltimoDiagnostico))
                    {
                        @Html.Raw(System.Net.WebUtility.HtmlEncode(Model.UltimoDiagnostico).Replace("\n", "<br/>"))
                    }
                    else
                    {
                        <span class="text-muted">—</span>
                    }
                </div>
            </div>
            <div class="col-md-4">
                <h6 class="text-muted">Próximo paso</h6>
                <p class="mb-0">@(Model.ProximoPaso ?? "Ninguno programado")</p>
            </div>
        </div>
    </div>
</section>

<!-- Timeline -->
<section class="card mb-4">
    <div class="card-header d-flex flex-wrap align-items-center justify-content-between gap-2">
        <h5 class="mb-0">Timeline (histórico)</h5>
        <div class="d-flex flex-wrap align-items-center gap-2">
            <form asp-action="Histograma" method="get" class="d-flex flex-wrap align-items-center gap-2 histograma-filtro-fechas">
                <input type="hidden" name="id" value="@Model.PacienteId" />
                @if (ViewBag.CitaId != null) { <input type="hidden" name="citaId" value="@ViewBag.CitaId" /> }
                <label class="mb-0 small text-muted">Desde</label>
                <input type="date" name="fechaInicio" value="@(ViewBag.FechaInicio != null ? ((DateTime)ViewBag.FechaInicio).ToString("yyyy-MM-dd") : "")" class="form-control form-control-sm" style="width: auto;" />
                <label class="mb-0 small text-muted">Hasta</label>
                <input type="date" name="fechaFin" value="@(ViewBag.FechaFin != null ? ((DateTime)ViewBag.FechaFin).ToString("yyyy-MM-dd") : "")" class="form-control form-control-sm" style="width: auto;" />
                <button type="submit" class="btn btn-sm btn-outline-primary">Filtrar</button>
            </form>
            @{
                var fi = ViewBag.FechaInicio as DateTime?;
                var ff = ViewBag.FechaFin as DateTime?;
                var rutaPdf = Url.Action("ExportarHistogramaPdf", new { id = Model.PacienteId, fechaInicio = fi, fechaFin = ff });
            }
            <a href="@rutaPdf" class="btn btn-sm btn-outline-danger" target="_blank" rel="noopener">Exportar PDF</a>
        </div>
    </div>
    @if (fi.HasValue || ff.HasValue)
    {
        <div class="card-body py-2 border-bottom small text-muted">
            Mostrando eventos @(fi.HasValue ? $"desde {fi.Value:dd/MM/yyyy}" : "desde el inicio") @(ff.HasValue ? $"hasta {ff.Value:dd/MM/yyyy}" : "hasta la fecha").
        </div>
    }
    <div class="card-body p-0">
        @if (Model.Timeline.Any())
        {
            <div class="table-responsive">
                <table class="table table-sm table-striped mb-0">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Tipo de evento</th>
                            <th>Descripción</th>
                            <th class="text-end">Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var h in Model.Timeline)
                        {
                            <tr>
                                <td>@h.FechaEvento.ToString("dd/MM/yyyy HH:mm")</td>
                                <td>@h.TipoEvento</td>
                                <td>@(h.Descripcion ?? "—")</td>
                                <td class="text-end">
                                    @{
                                        var esActualizacionOdonto = h.TipoEvento != null && (h.TipoEvento.Contains("periodontograma", StringComparison.OrdinalIgnoreCase) || h.TipoEvento.Contains("odontograma", StringComparison.OrdinalIgnoreCase));
                                    }
                                    @if (esActualizacionOdonto)
                                    {
                                        <a asp-action="VerEvento" asp-route-id="@h.Id" asp-route-pacienteId="@Model.PacienteId" class="btn btn-sm btn-outline-primary">Ver</a>
                                    }
                                    else if (h.CitaId.HasValue)
                                    {
                                        <a asp-controller="Atencion" asp-action="Expediente" asp-route-id="@h.CitaId.Value" class="btn btn-sm btn-outline-primary">Ver</a>
                                    }
                                    else
                                    {
                                        <a asp-action="VerEvento" asp-route-id="@h.Id" asp-route-pacienteId="@Model.PacienteId" class="btn btn-sm btn-outline-secondary">Ver</a>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <p class="p-3 mb-0 text-muted">No hay eventos en el historial.</p>
        }
    </div>
</section>
