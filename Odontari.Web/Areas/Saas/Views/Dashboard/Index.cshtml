@using Odontari.Web.Models
@{
    ViewData["Title"] = "Dashboard Global";
    var clinicasActivas = ViewBag.ClinicasActivas as int? ?? 0;
    var clinicasVencidas = ViewBag.ClinicasVencidas as int? ?? 0;
    var clinicasSuspendidas = ViewBag.ClinicasSuspendidas as int? ?? 0;
    var mrr = ViewBag.Mrr as decimal? ?? 0;
    var renovacionesProximas = ViewBag.RenovacionesProximas as IEnumerable<Suscripcion> ?? new List<Suscripcion>();
    var nuevasClinicasMes = ViewBag.NuevasClinicasMes as IEnumerable<Clinica> ?? new List<Clinica>();
    var actividadReciente = ViewBag.ActividadReciente as IEnumerable<AuditLog> ?? new List<AuditLog>();
}

<h1>Dashboard Global</h1>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-success">
            <div class="card-body">
                <h5 class="card-title">Clínicas activas</h5>
                <p class="card-text display-6">@clinicasActivas</p>
                <a asp-area="Saas" asp-controller="Clinicas" asp-action="Index" class="card-link">Ver clínicas</a>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-warning">
            <div class="card-body">
                <h5 class="card-title">Clínicas vencidas</h5>
                <p class="card-text display-6">@clinicasVencidas</p>
                <a asp-area="Saas" asp-controller="Suscripciones" asp-action="Index" class="card-link">Renovar</a>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-danger">
            <div class="card-body">
                <h5 class="card-title">Clínicas suspendidas</h5>
                <p class="card-text display-6">@clinicasSuspendidas</p>
                <a asp-area="Saas" asp-controller="Suscripciones" asp-action="Index" class="card-link">Ver suscripciones</a>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-primary">
            <div class="card-body">
                <h5 class="card-title">MRR estimado</h5>
                <p class="card-text display-6">@mrr.ToString("C2")</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Renovaciones próximas (30 días)</div>
            <div class="card-body p-0">
                @if (renovacionesProximas.Any())
                {
                    <ul class="list-group list-group-flush">
                        @foreach (var s in renovacionesProximas)
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                @s.Clinica?.Nombre
                                <span class="badge bg-secondary">@s.Vencimiento.ToString("d")</span>
                                <a asp-area="Saas" asp-controller="Suscripciones" asp-action="Index" class="btn btn-sm btn-outline-primary">Renovar</a>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <p class="p-3 mb-0 text-muted">No hay renovaciones en los próximos 30 días.</p>
                }
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Nuevas clínicas del mes</div>
            <div class="card-body p-0">
                @if (nuevasClinicasMes.Any())
                {
                    <ul class="list-group list-group-flush">
                        @foreach (var c in nuevasClinicasMes)
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                @c.Nombre <small class="text-muted">@c.Plan?.Nombre</small>
                                <span class="badge bg-info">@c.FechaCreacion.ToString("d")</span>
                                <a asp-area="Saas" asp-controller="Clinicas" asp-action="Edit" asp-route-id="@c.Id" class="btn btn-sm btn-outline-secondary">Ir</a>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <p class="p-3 mb-0 text-muted">Ninguna clínica nueva este mes.</p>
                }
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">Actividad reciente</div>
            <div class="card-body p-0">
                @if (actividadReciente.Any())
                {
                    <table class="table table-sm table-striped mb-0">
                        <thead><tr><th>Fecha</th><th>Acción</th><th>Entidad</th><th>Detalle</th></tr></thead>
                        <tbody>
                            @foreach (var a in actividadReciente)
                            {
                                <tr>
                                    <td>@a.CreadoAt.ToString("g")</td>
                                    <td>@a.Accion</td>
                                    <td>@(a.Entidad ?? "-") @(a.EntidadId != null ? $"#{a.EntidadId}" : "")</td>
                                    <td>@(a.Detalle ?? "-")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p class="p-3 mb-0 text-muted">Sin actividad reciente.</p>
                }
            </div>
        </div>
    </div>
</div>

<div class="mt-3">
    <a asp-area="Saas" asp-controller="Clinicas" asp-action="Index" class="btn btn-primary">Clínicas</a>
    <a asp-area="Saas" asp-controller="Suscripciones" asp-action="Index" class="btn btn-outline-secondary">Suscripciones / Pagos</a>
    <a asp-area="Saas" asp-controller="Planes" asp-action="Index" class="btn btn-outline-secondary">Planes</a>
</div>
